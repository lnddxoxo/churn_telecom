---
title: "quarto"
format: html
editor: visual
---

```{r}
churn<-read.csv("../WA_Fn-UseC_-Telco-Customer-Churn.csv",header=TRUE,sep=",")
str(churn)
summary(churn)
naChurn<-colSums(is.na(churn))
print(naChurn)


churn<-na.omit(churn)

na_churn<-colSums(is.na(churn))
print(na_churn)


head(churn)
tail(churn)

```

You can add options to executable code like this

```{r}
library(ggplot2)

vars_pure_quali_orig <- c("gender", "Partner", "Dependents", "MultipleLines", 
                          "InternetService", "OnlineSecurity", "OnlineBackup", 
                          "DeviceProtection", "TechSupport", "StreamingTV", 
                          "StreamingMovies", "Contract", "PaperlessBilling", 
                          "PaymentMethod")

# 2. La boucle directe (plus de fonction externe pour l'instant, on veut que Ã§a sorte !)
for (v in vars_pure_quali_orig) {
  
  # On crÃ©e le graphique en isolant la colonne avec churn[[v]]
  p <- ggplot(churn, aes(x = churn[[v]], fill = churn[[v]])) +
    geom_bar() +
    geom_text(stat = 'count', aes(label = after_stat(count)), vjust = -0.5) +
    theme_minimal() +
    labs(title = paste("Distribution de :", v), x = v, y = "Nombre de clients") +
    theme(legend.position = "none", axis.text.x = element_text(angle = 45, hjust = 1))
  
  # L'Ã©tape CRITIQUE : on force l'affichage
  print(p)
}
```

::: callout-note
Mettre en place le test de chi 2 entre toutes mes variables et le churn
:::

```{r}
##Transformer churn en factor
churn$Churn<-as.factor(churn$Churn)
```

```{r}
##Effectuer le test de chi 2 entr eles variables quali et la variable churn
##on doit etablir une fonction applique un tableua croisee entre chaque variables quali et la variable churn avec sapply

var_test<-vars_pure_quali_orig
res_chi2<-sapply(var_test,function(v){
  tab_c<-table(churn[[v]],churn$Churn)
  t_chi2<-chisq.test(tab_c)
  return(t_chi2$p.value)
})
res_sort<-sort(res_chi2)
print(res_sort)
```

```{r}
#Verifiez les modalites a faibles effectifs
for (v in var_test){
  effectif<-table(churn[[v]])
  freq<-prop.table(effectif)*100
  print(effectif)
  print(round(freq,2))
}
```

```{r}
# 1. DÃ©finir le seuil des 5%
seuil_5_pourcent <- 0.05 * nrow(churn)

# 2. Liste des variables actives
vars_actives <- c("Partner", "Dependents", "MultipleLines", 
                  "InternetService", "OnlineSecurity", "OnlineBackup", 
                  "DeviceProtection", "TechSupport", "StreamingTV", 
                  "StreamingMovies", "Contract", "PaperlessBilling", 
                  "PaymentMethod")

# 3. CrÃ©ation du tableau de vÃ©rification structurÃ©
# On utilise sapply pour crÃ©er une matrice qui sera ensuite transformÃ©e en dataframe
resultats_structure <- do.call(rbind, lapply(vars_actives, function(v) {
  
  # Calcul des effectifs et frÃ©quences pour la variable v
  eff <- table(churn[[v]])
  freq <- prop.table(eff) * 100
  
  # On combine les infos dans un petit tableau pour cette variable
  data.frame(
    Variable = v,
    Modalite = names(eff),
    Effectif = as.numeric(eff),
    Pourcentage = round(as.numeric(freq), 2)
  )
}))

# 4. Afficher le tableau final
print(resultats_structure)

#Verifier les modalites ayant moins de 5%
modalites_a_regrouper <- resultats_structure[resultats_structure$Pourcentage < 5, ]

# 3. Afficher le rÃ©sultat
print("--- ModalitÃ©s Ã  vÃ©rifier (< 5%) ---")
if (nrow(modalites_a_regrouper) > 0) {
  print(modalites_a_regrouper)
} else {
  print("Aucune modalitÃ© en dessous de 5%. Tout est OK !")
}
```

```{r}
library(ggplot2)
library(purrr)
library(scales)
library(dplyr)

# 1. DÃ©finition des variables
vars_quali <- c("gender", "Partner", "Dependents", "MultipleLines", 
                "InternetService", "OnlineSecurity", "OnlineBackup", 
                "DeviceProtection", "TechSupport", "StreamingTV", 
                "StreamingMovies", "Contract", "PaperlessBilling", 
                "PaymentMethod")

vars_quanti <- c("tenure", "MonthlyCharges", "TotalCharges")

# 2. Barplot empilÃ© en pourcentage (Quali vs Churn)
walk(vars_quali, function(v) {
  p <- ggplot(churn, aes(x = .data[[v]], fill = Churn)) +
    # position = "fill" calcule automatiquement les pourcentages
    geom_bar(position = "fill", alpha = 0.85) + 
    scale_y_continuous(labels = percent) +
    scale_fill_manual(values = c("No" = "#2196F3", "Yes" = "#F44336")) +
    theme_minimal() +
    theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
    labs(title = paste("Taux de Churn selon", v),
         x = v, y = "Proportion", fill = "Churn")
  
  print(p)
})

# 3. Barplot cÃ´te Ã  cÃ´te (Quali vs Churn â€” Volumes)
walk(vars_quali, function(v) {
  p <- ggplot(churn, aes(x = .data[[v]], fill = Churn)) +
    geom_bar(position = "dodge", alpha = 0.85) +
    scale_fill_manual(values = c("No" = "#2196F3", "Yes" = "#F44336")) +
    theme_minimal() +
    theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
    labs(title = paste("Nombre de Churn selon", v),
         x = v, y = "Nombre de clients", fill = "Churn")
  
  print(p)
})

# 4. Boxplot + DensitÃ© (Quanti vs Churn)
walk(vars_quanti, function(v) {
  # Boxplot
  p1 <- ggplot(churn, aes(x = Churn, y = .data[[v]], fill = Churn)) +
    geom_boxplot(alpha = 0.7, outlier.alpha = 0.3) +
    geom_jitter(aes(color = Churn), width = 0.15, alpha = 0.15, size = 0.8) +
    scale_fill_manual(values  = c("No" = "#2196F3", "Yes" = "#F44336")) +
    scale_color_manual(values = c("No" = "#2196F3", "Yes" = "#F44336")) +
    theme_minimal() +
    labs(title = paste("Boxplot de", v, "selon Churn"),
         x = "Churn", y = v) +
    theme(legend.position = "none")
  
  # DensitÃ©
  p2 <- ggplot(churn, aes(x = .data[[v]], fill = Churn)) +
    geom_density(alpha = 0.5) +
    scale_fill_manual(values = c("No" = "#2196F3", "Yes" = "#F44336")) +
    theme_minimal() +
    labs(title = paste("DensitÃ© de", v, "selon Churn"),
         x = v, y = "DensitÃ©", fill = "Churn")
  
  print(p1)
  print(p2)
})
```

```{r}
##Recoder les modalites "No INternet service" redondantes en no


library(FactoMineR)

# 1. Variables oÃ¹ "No internet service" doit Ãªtre recodÃ© en "No"
vars_internet_dep <- c("OnlineSecurity", "OnlineBackup", "DeviceProtection",
                       "TechSupport", "StreamingTV", "StreamingMovies")

for (v in vars_internet_dep){
  churn[[v]]<-as.character(churn[[v]])
  churn[[v]][churn[[v]]=="No internet service"]<-"No"
  churn[[v]]<-as.factor(churn[[v]])
}

churn$MultipleLines<-as.character(churn$MultipleLines)
churn$MultipleLines[churn$MultipleLines=="No phone service"]<-"No"
churn$MultipleLines<-as.factor(churn$MultipleLines)

#Verification :La modalite "No phone service" et "No internet service" ont disparu

table(churn$MultipleLines)
table(churn$OnlineSecurity)
```

```{r}
##Creation de tableau disjonctif complet(TDC

library(dplyr)

vars_quali_filtree <- c("Partner", "Dependents", "MultipleLines", 
                        "InternetService", "OnlineSecurity", "OnlineBackup", 
                        "DeviceProtection", "TechSupport", "StreamingTV", 
                        "StreamingMovies", "Contract", "PaperlessBilling", 
                        "PaymentMethod")

# 2. CrÃ©ation du dataframe actif filtrÃ©
data_active <-dplyr::select(churn,all_of(vars_quali_filtree))

# 3. CrÃ©ation du TDC sans gender
tdc <- tab.disjonctif(data_active)
print(tdc)
dim(tdc)

#L ACM

res_acm<-MCA(data_active,graph=FALSE)
```

```{r}

library(factoextra)
#Resultat des valeurs propres

res_eig<-get_eigenvalue(res_acm)
print(res_eig)
```

```{r}
##Correction du taux d'inertie
J      <- ncol(data_active)   # nombre de variables

lambda <- res_acm$eig[, 1]    # valeurs propres BRUTES (pas les %)

seuil  <- 1 / J               # seuil = 1/J



# Formule : si Î»s > 1/J â†’ Î»_corr = [(J/J-1) Ã— (Î»s - 1/J)]Â²

lambda_corr <- ifelse(

  lambda > seuil,

  ((J / (J - 1)) * (lambda - seuil))^2,

  0

)



# Taux corrigÃ©s

taux_corr_pct <- lambda_corr / sum(lambda_corr) * 100

taux_cum_corr <- cumsum(taux_corr_pct)



# Tableau final

df_benz <- data.frame(

  Dimension           = paste("Dim", seq_along(lambda)),

  `Î» brut`            = round(lambda, 5),

  `Î» corrigÃ©`         = round(lambda_corr, 5),

  `Taux brut (%)`     = round(res_acm$eig[, 2], 2),

  `Taux BenzÃ©cri (%)` = round(taux_corr_pct, 2),

  `Taux cumulÃ© (%)`   = round(taux_cum_corr, 2),

  check.names = FALSE

) |> dplyr::filter(`Î» corrigÃ©` > 0)



print(df_benz)
```

```{r}
#Identification des axes structurants

fviz_mca_var(res_acm,repel = TRUE)
```

```{r}
library(factoextra)

#Determinons les contributions des variables
res_contrib<-get_mca_var(res_acm)$contrib
print("Contribution des modalites:")
print(round(res_contrib,2))
```

```{r}

cos2_var <- get_mca_var(res_acm)$cos2
print("QualitÃ© de reprÃ©sentation (Cos2) des modalitÃ©s :")
print(round(cos2_var, 2))
```

```{r}
fviz_mca_ind(res_acm,label="none",alpha.ind = 0.5)
```

```{r}
#Graphique des variables corriges 
seuil_contrib<-100/nrow(res_acm$var$contrib)
fviz_mca_var(res_acm,repel=TRUE,
             select.var = list(contrib=15),
                               col.var="contrib",
                               gradient.cols = c("#FFA726","#E53935"),
                               labelsize = 4)+
               labs(title="Plan factoriel ACM, Top 15 modalites",subtitle = paste("Seuil de contribution ",round(seuil_contrib,2),"%"))+
               theme_minimal()
```

```{r}

# Graphique individus colorÃ© par Churn
fviz_mca_ind(res_acm,
             habillage     = churn$Churn,
             palette       = c("#2196F3","#F44336"),
             addEllipses   = TRUE,
             ellipse.level = 0.95,
             geom          = "point",
             alpha.ind     = 0.3,
             pointsize     = 1) +
  labs(title    = "Nuage des individus",
       subtitle = "Ellipses 95% â€” Rouge = Churn") +
  theme_minimal()
```

```{r}
res_acm_illus <- MCA(
  cbind(data_active, Churn = churn$Churn),
  quali.sup = ncol(data_active) + 1,
  graph = FALSE
)

```

```{r}
library(factoextra)
library(cluster)

# â”€â”€ Ã‰TAPE 1 : CoordonnÃ©es sur 4 axes â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
coords_cah <- res_acm$ind$coord[, 1:4]

# â”€â”€ Ã‰TAPE 2 : Matrice de distances (euclidienne) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
dist_mat <- dist(coords_cah, method = "euclidean")

# â”€â”€ Ã‰TAPE 3 : CAH avec Ward.D2 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
cah <- hclust(dist_mat, method = "ward.D2")


```

```{r}
# â”€â”€ Ã‰TAPE 4 : Dendrogramme â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
fviz_dend(cah,
          k              = 4,        # on suggÃ¨re 4 pour l'instant
          cex            = 0.5,
          palette        = "Set1",
          rect           = TRUE,
          rect_fill      = TRUE,
          rect_border    = "Set1",
          show_labels    = FALSE) +
  labs(title    = "Dendrogramme CAH â€” MÃ©thode Ward.D2",
       subtitle = "CoordonnÃ©es ACM (4 axes)") +
  theme_minimal()
```

```{r}
# â”€â”€ Ã‰TAPE 5 : Hauteurs de fusion (coude) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Pour choisir le bon nombre de clusters

hauteurs <- sort(cah$height, decreasing = TRUE)[1:15]

data.frame(
  Etape    = 1:15,
  Hauteur  = round(hauteurs, 4),
  Delta    = round(c(NA, diff(hauteurs)), 4)
) |> print()

# Graphique du coude
plot(1:15, hauteurs,
     type = "b", pch = 19,
     col  = "#1565C0",
     xlab = "Nombre de clusters",
     ylab = "Hauteur de fusion",
     main = "CritÃ¨re du coude â€” CAH Ward.D2")
abline(v = 4, col = "red", lty = 2)
```

```{r}
# â”€â”€ Ã‰TAPE 6 : DÃ©coupe de l'arbre â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
K <- 4  
classes_cah <- cutree(cah, k = K)
table(classes_cah)

```

```{r}
# â”€â”€ OPTION 1 : plot() de base â€” RAPIDE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
plot(cah,
     labels = FALSE,      # ne pas afficher les labels
     hang   = -1,
     main   = "Dendrogramme CAH â€” Ward.D2",
     xlab   = "Individus",
     ylab   = "Hauteur de fusion")

# Ajouter les rectangles pour K=4
rect.hclust(cah, k = 4, border = c("red","blue","green","orange"))
```

```{r}
# â”€â”€ OPTION 2 : Graphique du coude UNIQUEMENT â€” TRÃˆS RAPIDE â”€â”€â”€â”€â”€
# C'est suffisant pour choisir K !

hauteurs <- sort(cah$height, decreasing = TRUE)[1:10]

plot(1:10, hauteurs,
     type = "b",
     pch  = 19,
     col  = "#1565C0",
     xlab = "Nombre de clusters (K)",
     ylab = "Hauteur de fusion",
     main = "CritÃ¨re du coude â€” Choix de K")

# Annoter les points
text(1:10, hauteurs,
     labels = round(hauteurs, 3),
     pos = 3, cex = 0.8)
```

```{r}
# â”€â”€ OPTION 3 : Indice de Silhouette â€” RAPIDE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
library(cluster)

silhouette_scores <- c()

for (k in 2:6) {
  classes <- cutree(cah, k = k)
  sil     <- silhouette(classes, dist_mat)
  silhouette_scores[k] <- mean(sil[, 3])
}

plot(2:6, silhouette_scores[2:6],
     type = "b", pch = 19,
     col  = "#E53935",
     xlab = "Nombre de clusters K",
     ylab = "Score Silhouette moyen",
     main = "Silhouette â€” Choix optimal de K")
```

```{r}
# â”€â”€ ELLIPSES DES CLUSTERS SUR PLAN ACM â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

library(factoextra)
library(ggplot2)

# Visualisation clusters K-Means sur plan factoriel ACM
fviz_mca_ind(res_acm,
             habillage     = churn$Cluster,
             palette       = c("#F44336","#2196F3","#4CAF50","#FF9800"),
             addEllipses   = TRUE,
             ellipse.type  = "convex",  
             ellipse.level = 0.95,
             geom          = "point",
             alpha.ind     = 0.4,
             pointsize     = 1.2) +
  labs(title    = "Clusters K-Means sur Plan Factoriel ACM",
       subtitle = "K=4 â€” Ellipses de concentration Ã  95%",
       x = "Dim 1 â€” Niveau d'Ã©quipement digital (20.3%)",
       y = "Dim 2 â€” Engagement contractuel (13.4%)",
       color = "Cluster", fill = "Cluster") +
  theme_minimal()
```

```{r}
# â”€â”€ VERSION AVEC ELLIPSES DE CONFIANCE (plus rigoureuse) â”€â”€â”€â”€â”€â”€
fviz_mca_ind(res_acm,
             habillage     = churn$Cluster,
             palette       = c("#F44336","#2196F3","#4CAF50","#FF9800"),
             addEllipses   = TRUE,
             ellipse.type  = "norm",    # ellipse normale
             ellipse.level = 0.95,
             geom          = "point",
             alpha.ind     = 0.3,
             pointsize     = 1) +
  labs(title    = "Clusters K-Means sur Plan Factoriel ACM",
       subtitle = "Ellipses normales Ã  95% â€” Validation de la segmentation",
       x = "Dim 1 (20.3%)",
       y = "Dim 2 (13.4%)") +
  theme_minimal() +
  theme(legend.position = "bottom")
```

```{r}
# â”€â”€ BIPLOT CLUSTERS + MODALITÃ‰S â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Pour voir quelles modalitÃ©s caractÃ©risent chaque cluster

# Graphique des individus par cluster
p_ind <- fviz_mca_ind(res_acm,
                      habillage    = churn$Cluster,
                      palette      = c("#F44336","#2196F3","#4CAF50","#FF9800"),
                      addEllipses  = TRUE,
                      ellipse.level = 0.90,
                      geom         = "point",
                      alpha.ind    = 0.3,
                      pointsize    = 0.8)

# Graphique des modalitÃ©s top 15
p_var <- fviz_mca_var(res_acm,
                      select.var = list(contrib = 15),
                      repel      = TRUE,
                      col.var    = "darkblue",
                      labelsize  = 3)

# Superposition manuelle
p_ind +
  geom_point(data = as.data.frame(res_acm$var$coord[, 1:2]) |>
               tibble::rownames_to_column("modalite") |>
               dplyr::slice_max(order_by = rowSums(res_acm$var$contrib[,1:2]),
                                n = 15),
             aes(x = `Dim 1`, y = `Dim 2`),
             color = "darkblue", size = 3, shape = 17,
             inherit.aes = FALSE) +
  labs(title    = "Biplot â€” Clusters & ModalitÃ©s caractÃ©ristiques",
       subtitle = "â–² = modalitÃ©s les plus contributives") +
  theme_minimal()
```

```{r}
# DÃ©coupe Ã  K=4
K <- 4
classes_cah <- cutree(cah, k = K)
cat("RÃ©partition CAH :\n")
print(table(classes_cah))

# Consolidation K-Means
set.seed(42)
km <- kmeans(coords_cah, centers = K, nstart = 25, iter.max = 100)
cat("\nRÃ©partition K-Means :\n")
print(table(km$cluster))

# Comparaison CAH vs K-Means
cat("\nTableau de concordance CAH vs K-Means :\n")
print(table(CAH = classes_cah, KMeans = km$cluster))

# Ajouter au dataframe
churn$Cluster_CAH   <- factor(classes_cah)
churn$Cluster_KMeans <- factor(km$cluster)
```

```{r}
# Finalisation
churn$Cluster <- factor(km$cluster,
                        labels = c("Cluster 1", "Cluster 2",
                                   "Cluster 3", "Cluster 4"))
table(churn$Cluster)
```

```{r}
# â”€â”€ PROFILING COMPLET DES CLUSTERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
install.packages("kableExtra")
library(dplyr)
library(knitr)
library(kableExtra)


churn |>
  group_by(Cluster) |>
  summarise(
    `Nb clients`       = n(),
    `% du total`       = round(n() / nrow(churn) * 100, 1),
    `Taux Churn (%)`   = round(mean(Churn == "Yes") * 100, 1),
    `AnciennetÃ© moy.`  = round(mean(tenure), 1),
    `Charge mens. moy` = round(mean(MonthlyCharges), 1),
    .groups = "drop"
  ) |>
  kable(caption = "SynthÃ¨se des 4 clusters") |>
  kable_styling(bootstrap_options = c("striped","hover","bordered"))
```

```{r}
# â”€â”€ 2. Profil contractuel par cluster â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
churn |>
  group_by(Cluster, Contract) |>
  summarise(n = n(), .groups = "drop") |>
  group_by(Cluster) |>
  mutate(pct = round(n / sum(n) * 100, 1)) |>
  select(-n) |>
  tidyr::pivot_wider(names_from = Contract, values_from = pct) |>
  kable(caption = "Type de contrat par cluster (%)") |>
  kable_styling(bootstrap_options = c("striped","hover"))
```

```{r}
# â”€â”€ 3. Profil Internet par cluster â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
churn |>
  group_by(Cluster, InternetService) |>
  summarise(n = n(), .groups = "drop") |>
  group_by(Cluster) |>
  mutate(pct = round(n / sum(n) * 100, 1)) |>
  select(-n) |>
  tidyr::pivot_wider(names_from = InternetService, values_from = pct) |>
  kable(caption = "Type Internet par cluster (%)") |>
  kable_styling(bootstrap_options = c("striped","hover"))
```

```{r}
# â”€â”€ 4. Test Khi-deux â€” Churn vs Cluster â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
chi2 <- chisq.test(table(churn$Cluster, churn$Churn))
cat("Test Khi-deux Cluster vs Churn :\n")
cat("ChiÂ² =", round(chi2$statistic, 2), "\n")
cat("p-value =", format.pval(chi2$p.value, digits = 3), "\n")
cat("Conclusion :", 
    ifelse(chi2$p.value < 0.05, 
           "âœ… Lien significatif entre Cluster et Churn",
           "âŒ Pas de lien significatif"), "\n")
```

```{r}
# â”€â”€ 5. Visualisation Churn par cluster â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
library(ggplot2)

churn |>
  group_by(Cluster, Churn) |>
  summarise(n = n(), .groups = "drop") |>
  group_by(Cluster) |>
  mutate(pct = n / sum(n)) |>
  ggplot(aes(x = Cluster, y = pct, fill = Churn)) +
  geom_col(alpha = 0.85) +
  geom_text(aes(label = scales::percent(pct, accuracy = 0.1)),
            position = position_stack(vjust = 0.5),
            color = "white", fontface = "bold", size = 4) +
  scale_fill_manual(values = c("No" = "#2196F3", "Yes" = "#F44336")) +
  scale_y_continuous(labels = scales::percent) +
  labs(title    = "Taux de Churn par Cluster",
       subtitle = "K-Means K=4 sur axes ACM",
       x = "Cluster", y = "Proportion") +
  theme_minimal()
```

::: callout-note
```         

---

## ğŸ¯ Mais surtout â€” Tes rÃ©sultats sont EXTRAORDINAIRES !

Voici l'interprÃ©tation et les **noms mÃ©tier** des clusters :

| Cluster | Taux Churn | Contrat | Internet | AnciennetÃ© | Nom mÃ©tier |
|---------|-----------|---------|----------|------------|------------|
| **C1** | ğŸ”´ **52.7%** | 89% mensuel | 95% Fibre | 24 mois | **"Les Fugitifs Fibre"** |
| **C2** | ğŸŸ¢ **8.6%** | 40% Two year | 96% **Sans internet** | 30 mois | **"Les FidÃ¨les TÃ©lÃ©phonie"** |
| **C3** | ğŸŸ¢ **9.2%** | 56% Two year | 53% DSL | 56 mois | **"Les Loyaux DSL"** |
| **C4** | ğŸŸ¡ **27.2%** | 76% mensuel | 89% DSL | 20 mois | **"Les PrÃ©caires DSL"** |

---

## ğŸ“‹ InterprÃ©tation complÃ¨te

**Cluster 1 â€” "Les Fugitifs Fibre" ğŸ”´**
```

â†’ Churn 52.7% â€” le plus dangereux ! â†’ 95% Fibre optique + 89% contrat mensuel â†’ Charges Ã©levÃ©es (86.6\$) mais anciennetÃ© faible â†’ Profil : clients attirÃ©s par la Fibre mais pas fidÃ©lisÃ©s â†’ ACTION : Offre de migration vers contrat annuel URGENTE

```         

**Cluster 2 â€” "Les FidÃ¨les TÃ©lÃ©phonie" ğŸŸ¢**
```

â†’ Churn 8.6% â€” quasi inexistant â†’ 96% sans internet â€” clients tÃ©lÃ©phonie pure â†’ Charges trÃ¨s faibles (23.2\$) â†’ Profil : clients simples, stables, peu rentables â†’ ACTION : Upsell Internet DSL

```         

**Cluster 3 â€” "Les Loyaux DSL" ğŸŸ¢**
```

â†’ Churn 9.2% â€” trÃ¨s faible â†’ 56% contrat Two year + anciennetÃ© 56 mois ! â†’ 53% DSL â€” clients Ã©tablis â†’ Profil : clients fidÃ¨les premium â†’ ACTION : Programme ambassadeur / parrainage

```         

**Cluster 4 â€” "Les PrÃ©caires DSL" ğŸŸ¡**
```

â†’ Churn 27.2% â€” risque modÃ©rÃ© â†’ 76% contrat mensuel + DSL â†’ AnciennetÃ© faible (20 mois) â†’ Profil : clients rÃ©cents non engagÃ©s â†’ ACTION : Migration vers contrat annuel

```         

---

## âœ… Conclusion Khi-deux
```

ChiÂ² = 1286.43, p \< 2e-16 â†’ La segmentation est statistiquement trÃ¨s significative â†’ Le Cluster explique fortement le Churn â†’ Parfait pour justifier la dÃ©marche dans ton rapport !
:::

```{r}
# â”€â”€ SILHOUETTE PAR INDIVIDU â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
library(cluster)

sil <- silhouette(km$cluster, dist_mat)
sil_df <- as.data.frame(sil[, 1:3])
colnames(sil_df) <- c("Cluster", "Voisin", "Silhouette")

# Score moyen par cluster
sil_df |>
  mutate(Cluster = paste("Cluster", Cluster)) |>
  group_by(Cluster) |>
  summarise(
    `Score Silhouette moyen` = round(mean(Silhouette), 3),
    `% bien classÃ©s (>0)`    = round(mean(Silhouette > 0) * 100, 1),
    `% mal classÃ©s (<0)`     = round(mean(Silhouette < 0) * 100, 1)
  ) |>
  kable(caption = "QualitÃ© de classification par cluster") |>
  kable_styling(bootstrap_options = c("striped","hover","bordered"))
```

```{r}
# â”€â”€ VISUALISATION SILHOUETTE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
fviz_silhouette(sil,
                palette      = c("#F44336","#2196F3","#4CAF50","#FF9800"),
                ggtheme      = theme_minimal()) +
  labs(title    = "Graphique de Silhouette â€” K=4",
       subtitle = "Score > 0 = bien classÃ© | Score < 0 = mal classÃ©")
```

```{r}
# â”€â”€ QUI SONT LES INDIVIDUS MAL CLASSÃ‰S ? â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
sil_df$Cluster_km <- churn$Cluster

mal_classes <- sil_df |>
  filter(Silhouette < 0) |>
  mutate(Cluster = paste("Cluster", Cluster),
         Voisin  = paste("Cluster", Voisin))

cat("Nombre d'individus mal classÃ©s :", nrow(mal_classes), "\n")
cat("Soit", round(nrow(mal_classes)/nrow(churn)*100, 1), "% du total\n\n")

# OÃ¹ vont-ils ?
table(mal_classes$Cluster, mal_classes$Voisin) |>
  kable(caption = "Individus mal classÃ©s â€” Cluster actuel vs Cluster voisin") |>
  kable_styling(bootstrap_options = c("striped","hover"))
```

::: callout-note
## StratÃ©gie Marketing â€” Les 4 Segments

|   | **Cluster 1** ğŸ”´ | **Cluster 2** ğŸŸ¢ | **Cluster 3** ğŸŸ¢ | **Cluster 4** ğŸŸ¡ |
|----|----|----|----|----|
| **Nom** | Fugitifs Fibre | FidÃ¨les TÃ©lÃ©phonie | Loyaux DSL | PrÃ©caires DSL |
| **Taux Churn** | 52.7% | 8.6% | 9.2% | 27.2% |
| **Taille** | 2178 (31%) | 1586 (23%) | 1690 (24%) | 1578 (22%) |
| **Profil** | Fibre + mensuel + seul | Sans internet + stable | DSL + Two year + famille | DSL + mensuel + rÃ©cent |
| **Risque** | ğŸ”´ CRITIQUE | ğŸŸ¢ FAIBLE | ğŸŸ¢ FAIBLE | ğŸŸ¡ MODÃ‰RÃ‰ |

### ğŸ”´ Cluster 1 â€” "Fugitifs Fibre" â€” PRIORITÃ‰ ABSOLUE

**ProblÃ¨me :** Client attirÃ© par la Fibre mais pas fidÃ©lisÃ©. Paye cher (86\$/mois) sans engagement.

**Actions :**

-   

-   ğŸ¯ **Action 1** : Offre de rÃ©tention immÃ©diate â€” migration contrat annuel avec **remise de 15%**

-   

-   ğŸ¯ **Action 2** : Appel proactif du service client dans les **30 premiers jours**

-   

-   ğŸ¯ **Action 3** : Bundle groupÃ© Fibre + SÃ©curitÃ© + Streaming Ã  tarif fixe

-   

**KPI cible :** RÃ©duire le churn de 52.7% â†’ 35% en 6 mois

### ğŸŸ¡ Cluster 4 â€” "PrÃ©caires DSL" â€” SURVEILLANCE ACTIVE

**ProblÃ¨me :** Client rÃ©cent (20 mois), pas encore engagÃ©, risque de partir si pas de valeur perÃ§ue.

**Actions :**

-   

-   ğŸ¯ **Action 1** : Programme onboarding **0-12 mois** avec bonus fidÃ©litÃ©

-   

-   ğŸ¯ **Action 2** : Proposition contrat annuel Ã  **6 mois** d'anciennetÃ©

-   

-   ğŸ¯ **Action 3** : Offre dÃ©couverte sÃ©curitÃ© en ligne **3 mois gratuits**

-   

**KPI cible :** RÃ©duire le churn de 27.2% â†’ 18% en 6 mois

### ğŸŸ¢ Cluster 3 â€” "Loyaux DSL" â€” PROGRAMME AMBASSADEUR

**ProblÃ¨me :** Pas de problÃ¨me â€” ce sont tes meilleurs clients (56 mois d'anciennetÃ© !).

**Actions :**

-   

-   ğŸ¯ **Action 1** : Programme **parrainage** â€” rÃ©compense par mois offert

-   

-   ğŸ¯ **Action 2** : Offre de migration vers Fibre avec tarif prÃ©fÃ©rentiel

-   

-   ğŸ¯ **Action 3** : Statut **"Client Premium"** avec avantages exclusifs

-   

**KPI cible :** Maintenir churn \< 10% et augmenter panier moyen

### ğŸŸ¢ Cluster 2 â€” "FidÃ¨les TÃ©lÃ©phonie" â€” UPSELL

**ProblÃ¨me :** Clients stables mais peu rentables (23\$/mois seulement).

**Actions :**

-   

-   ğŸ¯ **Action 1** : Offre dÃ©couverte **Internet DSL** Ã  prix rÃ©duit

-   

-   ğŸ¯ **Action 2** : Bundle TÃ©lÃ©phone + Internet entrÃ©e de gamme

-   

-   ğŸ¯ **Action 3** : Communication sur les bÃ©nÃ©fices du numÃ©rique

-   

**KPI cible :** Convertir 20% vers offre Internet â†’ +15\$/mois/client

## ğŸ“Š Matrice de PrioritÃ©

```         
ROI POTENTIEL     â†‘     â”‚  C3 Loyaux    C1 Fugitifs     â”‚  (maintenir)  (URGENT)     â”‚     â”‚  C2 FidÃ¨les   C4 PrÃ©caires     â”‚  (upsell)     (prÃ©venir)     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’               URGENCE
```

Lance maintenant le code des
:::

```{r}
# â”€â”€ ACM CORRECTE AVEC VARIABLES SUPPLÃ‰MENTAIRES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

# VÃ©rifier les noms exacts de ton dataframe
names(churn)

# PrÃ©parer le dataframe complet ordonnÃ©
data_acm_complet <- churn |>
  dplyr::select(
    # â”€â”€ Variables ACTIVES (13) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    Partner, Dependents, MultipleLines,
    InternetService, OnlineSecurity, OnlineBackup,
    DeviceProtection, TechSupport, StreamingTV,
    StreamingMovies, Contract, PaperlessBilling,
    PaymentMethod,
    # â”€â”€ Variables QUALI illustratives â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    gender, Churn,
    # â”€â”€ Variables QUANTI illustratives â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    tenure, MonthlyCharges, TotalCharges
  )

# VÃ©rifier les positions
cat("Colonnes 1-13 (actives) :\n")
print(names(data_acm_complet)[1:13])
cat("\nColonnes 14-15 (quali.sup) :\n")
print(names(data_acm_complet)[14:15])
cat("\nColonnes 16-18 (quanti.sup) :\n")
print(names(data_acm_complet)[16:18])
```

```{r}
# â”€â”€ LANCER L'ACM AVEC SUPPLÃ‰MENTAIRES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
res_acm_complet <- MCA(
  data_acm_complet,
  quali.sup  = 14:15,    # gender, Churn
  quanti.sup = 16:18,    # tenure, MonthlyCharges, TotalCharges
  ncp        = 5,
  graph      = FALSE
)
```

```{r}
# â”€â”€ RÃ‰SULTATS VARIABLES QUALI SUP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# RÃ¨gle cours Baffo slide 34 : |vt| > 2 â†’ significatif

cat("=== VALEURS-TEST VARIABLES QUALI SUP ===\n")
cat("(Significatif si |vt| > 2)\n\n")

vtest <- as.data.frame(res_acm_complet$quali.sup$v.test)

# Churn
cat("--- CHURN ---\n")
churn_vt <- data.frame(
  ModalitÃ©  = rownames(vtest)[grepl("Yes|No", rownames(vtest))],
  `Axe 1`   = round(vtest[grepl("Yes|No", rownames(vtest)), 1], 3),
  `Axe 2`   = round(vtest[grepl("Yes|No", rownames(vtest)), 2], 3),
  `Axe 3`   = round(vtest[grepl("Yes|No", rownames(vtest)), 3], 3),
  `Axe 4`   = round(vtest[grepl("Yes|No", rownames(vtest)), 4], 3),
  check.names = FALSE
) |>
  mutate(
    `Sig.Ax1` = ifelse(abs(`Axe 1`) > 2, "âœ…", "âŒ"),
    `Sig.Ax2` = ifelse(abs(`Axe 2`) > 2, "âœ…", "âŒ"),
    `Sig.Ax3` = ifelse(abs(`Axe 3`) > 2, "âœ…", "âŒ"),
    `Sig.Ax4` = ifelse(abs(`Axe 4`) > 2, "âœ…", "âŒ")
  )
print(churn_vt)

# Gender
cat("\n--- GENDER ---\n")
gender_vt <- data.frame(
  ModalitÃ©  = rownames(vtest)[grepl("Male|Female", rownames(vtest))],
  `Axe 1`   = round(vtest[grepl("Male|Female", rownames(vtest)), 1], 3),
  `Axe 2`   = round(vtest[grepl("Male|Female", rownames(vtest)), 2], 3),
  check.names = FALSE
) |>
  mutate(
    `Sig.Ax1` = ifelse(abs(`Axe 1`) > 2, "âœ…", "âŒ"),
    `Sig.Ax2` = ifelse(abs(`Axe 2`) > 2, "âœ…", "âŒ")
  )
print(gender_vt)
```

```{r}
# â”€â”€ VISUALISATION QUANTI SUP SUR PLAN FACTORIEL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
fviz_mca_var(res_acm_complet,
             choice    = "quanti.sup",
             col.quanti.sup = "#9C27B0",
             repel     = TRUE,
             labelsize = 4) +
  labs(title    = "Variables quantitatives supplÃ©mentaires",
       subtitle = "Projection sur plan factoriel ACM") +
  theme_minimal()
```

```{r}
# â”€â”€ VISUALISATION QUALI SUP (Churn) SUR PLAN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
fviz_mca_var(res_acm_complet,
             choice = "quali.sup",
             col.quali.sup  = "#E91E63",
             repel          = TRUE,
             labelsize       = 5) +
  labs(title    = "Variables qualitatives supplÃ©mentaires",
       subtitle = "Churn et Gender â€” Valeur-test |vt| > 2") +
  theme_minimal()
```
